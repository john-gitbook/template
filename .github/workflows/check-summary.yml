name: Auto-update SUMMARY.md

on:
  push:
    paths:
      - '**.md'

permissions:
  contents: write

jobs:
  update-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Update SUMMARY.md with missing files
        run: |
          #!/bin/bash
          set -e
          
          # Find all .md files except SUMMARY.md and README.md
          all_md_files=$(find . -type f -name "*.md" \
            ! -path "./SUMMARY.md" \
            ! -path "./README.md" \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            | sort)
          
          # Read SUMMARY.md content
          summary_content=$(cat SUMMARY.md)
          
          # Track missing files
          missing_files=()
          
          # Check each .md file
          for file in $all_md_files; do
            # Remove leading ./ from path
            clean_path="${file#./}"
            
            # Check if the file path appears in SUMMARY.md
            if ! echo "$summary_content" | grep -q "$clean_path"; then
              missing_files+=("$clean_path")
            fi
          done
          
          # If there are missing files, add them to SUMMARY.md
          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "ðŸ“ Adding missing files to SUMMARY.md:"
            
            # Append to SUMMARY.md
            echo "" >> SUMMARY.md
            echo "## Auto-added pages" >> SUMMARY.md
            
            for file in "${missing_files[@]}"; do
              # Extract filename without extension for title
              filename=$(basename "$file" .md)
              # Convert hyphens/underscores to spaces and capitalize
              title=$(echo "$filename" | sed 's/[-_]/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1')
              
              echo "* [$title]($file)" >> SUMMARY.md
              echo "  - Added: $file"
            done
            
            echo "âœ… SUMMARY.md updated with ${#missing_files[@]} new file(s)"
          else
            echo "âœ… All markdown files are already in SUMMARY.md"
          fi
      
      - name: Commit changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if git diff --quiet SUMMARY.md; then
            echo "No changes to commit"
          else
            git add SUMMARY.md
            git commit -m "chore: auto-update SUMMARY.md with new pages"
            git push
          fi